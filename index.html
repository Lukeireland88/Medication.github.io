<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paul Ireland Medication Tracker</title>

  <!-- Favicon and app icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' ry='20' fill='white'/><rect x='15' y='35' width='70' height='30' rx='15' ry='15' fill='%232563eb'/><line x1='50' y1='35' x2='50' y2='65' stroke='white' stroke-width='6'/></svg>">
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABMklEQVRYR+2X0Q2DMBBFz1AUwAtwAFzABdwAF3ABuVgE7YgUSoiqK8E0Q0/7b2QykZlQ+f8b3ZmcwnNAhAAZgAYeMKvXwMg6yBa2IESEATrhrfABTAt9W79GMtDap4Az6D6OwPfw4kMcFkcLeBpcAyD/yQYyIGJs9jCEvTdHcm0BLeIJQFgBo7GqFtvG/IOU1SBcRkHZZJ2gDbC6gBwqFmGfRS+UUHi7pr8gTKioeMt1Dh6cfaxlZPCQbMrbMpI3AdkWRY0dQy5ak1U5tVEnZcXbZyjqTsEoFsU93tkP4+VcsAZ+0JY0aqj7yKwAWZTvNfYC4tQTpZz/vEKdM6NugQO7sPhNPXOrvVJ0r2oWg+TjyeB4cRtF2we8AAAAASUVORK5CYII=" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2563eb">
  <!-- Manifest will be generated at runtime so this can stay a single file -->
  <script>
    (function(){
      const svgIcon = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' ry='20' fill='white'/><rect x='15' y='35' width='70' height='30' rx='15' ry='15' fill='%232563eb'/><line x1='50' y1='35' x2='50' y2='65' stroke='white' stroke-width='6'/></svg>";
      const manifest = {
        name: "Paul Ireland Medication Tracker",
        short_name: "Meds",
        start_url: ".",
        scope: ".",
        display: "standalone",
        background_color: "#ffffff",
        theme_color: "#2563eb",
        icons: [
          { src: svgIcon, type: "image/svg+xml", sizes: "any", purpose: "any maskable" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], { type: "application/manifest+json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = url;
      document.head.appendChild(link);
    })();
  </script>

  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-weak: #dbeafe;
      --border: #e5e7eb;
      --multi-bg: #fff7cc;
      --disabled: #f3f4f6;
    }

    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text); background: var(--bg); display: grid; place-items: start center;
    }

    .container { width: min(900px, 96vw); padding: 24px; }

    header { display: grid; gap: 8px; margin-bottom: 16px; }
    h1 { margin: 0; font-size: clamp(22px, 3.8vw, 30px); }
    .sub { color: var(--muted); font-size: clamp(13px, 1.5vw, 14px); }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }

    /* Collapsible time picker */
    .time-toggle { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 600; }
    .time-options { display: none; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 12px; border-bottom: 1px solid var(--border); }
    .time-btn {
      appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--text);
      padding: 10px 12px; border-radius: 12px; font-weight: 600; cursor: pointer; text-align: center;
    }
    .time-btn[aria-pressed="true"] { border-color: var(--accent); background: var(--accent-weak); color: var(--accent); }

    /* Table */
    .table-wrap { padding: 0 12px 12px; }
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    thead th { text-align: left; font-size: clamp(13px, 1.6vw, 14px); color: var(--muted); background: #f9fafb; border-bottom: 1px solid var(--border); padding: 12px; }
    tbody td { padding: 14px; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: clamp(14px, 2.2vw, 16px); word-break: break-word; }
    tr:last-child td { border-bottom: none; }
    .taken td { color: #6b7280; text-decoration: line-through; }
    .pill { font-weight: 600; }
    .multi-row td { background: var(--multi-bg); }
    .badge { font-size: 11px; display: block; margin-top: 4px; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--border); width: fit-content; color: var(--muted); }

    .disabled-row td { color: var(--muted); background: var(--disabled); }
    .disabled-row input[type="checkbox"] { pointer-events: none; opacity: 0.5; }

      /* Notices */
    .notice {margin: 8px 12px 0;background: #ffcccc;border: 1px solid var(--border);border-radius: 10px;padding: 10px 12px;color: var(--text);}

    /* Footer summary */
    .summary { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-top: 1px solid var(--border); color: var(--muted); font-size: clamp(12px, 1.8vw, 14px); }

    input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--accent); }

    @media (max-width: 480px) {
      .time-options { grid-template-columns: 1fr; }
      input[type="checkbox"] { width: 28px; height: 28px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Medication Tracker</h1>
      <div id="dateLine" class="sub"></div>
    </header>

    <section class="card">
      <div class="time-toggle" onclick="toggleOptions()">
        <span id="currentLabel">Showing: Morning</span>
        <span id="toggleArrow">▼</span>
      </div>
      <div class="time-options" id="timeOptions">
        <button class="time-btn" data-time="Morning" aria-pressed="true">Morning</button>
        <button class="time-btn" data-time="Lunch" aria-pressed="false">Lunch</button>
        <button class="time-btn" data-time="Evening" aria-pressed="false">Evening</button>
        <button class="time-btn" data-time="Night" aria-pressed="false">Night</button>
      </div>

      <div id="ferrousNotice" class="notice" style="display:none"></div>
      <div id="azithroNotice" class="notice" style="display:none"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th scope="col">Taken</th>
              <th scope="col">Medication</th>
              <th scope="col">When</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="summary">
        <div><strong id="remaining"></strong> left for this time.</div>
        <div>
          Highlighted items show all times they are used (tray: Multiple). Checklist resets on refresh.<br>
          <span id="ferrousNote" style="color: var(--muted);"></span><br>
          <span id="azithroNote" style="color: var(--muted);"></span>
        </div>
      </div>
    </section>
  </div>

  <script>
    const MEDS = {
      Morning: [
        { name: "Isosorbide (Half Tablet)", when: "Daily" },
		{ name: "Clopidogrel", when: "Daily" },
		{ name: "Diltiazem", when: "Daily" },
		{ name: "Folic acid", when: "Daily" },
        { name: "Levetiracetam (1000 mg)", when: "Daily" },
		{ name: "Levetiracetam (500 mg)", when: "Daily" },
        { name: "Phenoxymethylpenicillin", when: "Daily" },
        { name: "Trimbow inhaler (Red)", when: "Daily" },
		{ name: "Paracetamol (x2)", when: "Daily" },
      ],
      Lunch: [
		{ name: "Paracetamol (x2)", when: "Daily" },
      ],
      Evening: [
        { name: "Paracetamol (x2)", when: "Daily" },
      ],
      Night: [
        
        { name: "Diltiazem", when: "Daily" },
        { name: "Levetiracetam (1000 mg)", when: "Daily" },
		{ name: "Levetiracetam (500 mg)", when: "Daily" },
        { name: "Phenoxymethylpenicillin", when: "Daily" },
        { name: "Trimbow inhaler (Red)", when: "Daily" },
		{ name: "Paracetamol (x2)", when: "Daily" },
      ],
    };

    // Map of normalized full med name -> list of times it appears
    const multiMap = (() => {
      const m = new Map();
      const norm = s => s.trim().toLowerCase();
      for (const [time, section] of Object.entries(MEDS)) {
        for (const med of section) {
          const key = norm(med.name);
          if (!m.has(key)) m.set(key, []);
          if (!m.get(key).includes(time)) m.get(key).push(time);
        }
      }
      return { map: m, norm };
    })();

    let currentTime = 'Morning';

   


    function formatDateLine() {
      const d = new Date();
      const weekday = d.toLocaleDateString(undefined, { weekday: 'long' });
      const date = d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('dateLine').textContent = `${weekday} · ${date}`;
    }

    function toggleOptions() {
      const options = document.getElementById('timeOptions');
      const arrow = document.getElementById('toggleArrow');
      const isOpen = options.style.display === 'grid';
      options.style.display = isOpen ? 'none' : 'grid';
      arrow.textContent = isOpen ? '▼' : '▲';
    }

    function setTime(time) {
      currentTime = time;
      document.querySelectorAll('.time-btn').forEach(btn => btn.setAttribute('aria-pressed', String(btn.dataset.time === time)));
      document.getElementById('timeOptions').style.display = 'none';
      document.getElementById('toggleArrow').textContent = '▼';
      render();
    }

    function getDefaultTime() {
      const hour = new Date().getHours();
      if (hour < 12) return 'Morning';
      if (hour < 15) return 'Lunch';
      if (hour < 19) return 'Evening';
      return 'Night';
    }

    function render() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      MEDS[currentTime].forEach((med) => {
        const row = document.createElement('tr');

        const checkCell = document.createElement('td');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.addEventListener('change', () => {
          row.classList.toggle('taken', cb.checked);
          updateRemaining();
        });
        checkCell.appendChild(cb);

        const nameCell = document.createElement('td');
        nameCell.className = 'pill';
        nameCell.textContent = med.name;

        const whenCell = document.createElement('td');
        whenCell.textContent = med.when;

        const times = multiMap.map.get(multiMap.norm(med.name)) || [];
        if (times.length > 1) {
          row.classList.add('multi-row');
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = 'Multiple: ' + times.join(', ');
          nameCell.appendChild(badge);
        }

        // Grey out Ferrous on off-days
        if (med.name.toLowerCase().startsWith('ferrous fumarate') && !isFerrousToday()) {
          row.classList.add('disabled-row');
          cb.disabled = true;
        }
        // Grey out Azithromycin on non Mon/Wed/Fri
        if (med.name.toLowerCase().startsWith('azithromycin') && !isAzithroToday()) {
          row.classList.add('disabled-row');
          cb.disabled = true;
        }

        row.appendChild(checkCell);
        row.appendChild(nameCell);
        row.appendChild(whenCell);
        tbody.appendChild(row);
      });

      updateRemaining();
      document.getElementById('currentLabel').textContent = `Showing: ${currentTime}`;

      // Morning-only notices
      const ferrousN = document.getElementById('ferrousNotice');
      if (currentTime === 'Morning' && !isFerrousToday()) {
        const next = nextFerrousDue();
        const nextStr = next.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
        ferrousN.textContent = `Ferrous Fumarate not due today (next due: ${nextStr}).`;
        ferrousN.style.display = 'block';
      } else {
        ferrousN.style.display = 'none';
      }
      const azithroN = document.getElementById('azithroNotice');
      if (currentTime === 'Morning' && !isAzithroToday()) {
        const nextA = nextAzithroDue();
        const nextAStr = nextA.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
        azithroN.textContent = `Azithromycin not due today (next due: ${nextAStr}).`;
        azithroN.style.display = 'block';
      } else {
        azithroN.style.display = 'none';
      }

      // Summary lines
      const ferrousNote = document.getElementById('ferrousNote');
      if (ferrousNote) ferrousNote.textContent = isFerrousToday() ? "Ferrous Fumarate is due today." : "Ferrous Fumarate is not due today.";
      const azithroNote = document.getElementById('azithroNote');
      if (azithroNote) azithroNote.textContent = isAzithroToday() ? "Azithromycin is due today (Mon/Wed/Fri)." : "Azithromycin is not due today.";
    }

    function updateRemaining() {
      const checkboxes = Array.from(document.querySelectorAll('tbody input[type=\"checkbox\"]'));
      const remaining = checkboxes.filter(cb => !cb.checked && !cb.disabled).length;
      document.getElementById('remaining').textContent = `${remaining} item${remaining !== 1 ? 's' : ''}`;
    }

    // Wire up
    document.querySelectorAll('.time-btn').forEach(btn => btn.addEventListener('click', () => setTime(btn.dataset.time)));

    // Init
    formatDateLine();
    setTime(getDefaultTime());

    // --- Lightweight self-tests (logged to the console) ---
    (function runSelfTests(){
      const logOK = msg => console.log('%c✔ ' + msg, 'color: #16a34a');
      const logErr = msg => console.error('✖ ' + msg);
      try {
        // Ferrous schedule tests
        const d18 = new Date(2025, 8, 18);
        const d19 = new Date(2025, 8, 19);
        const d20 = new Date(2025, 8, 20);
        const d21 = new Date(2025, 8, 21);
        console.assert(isFerrousToday(d18) === true, '18 Sep should be due');
        console.assert(isFerrousToday(d19) === false, '19 Sep should NOT be due');
        console.assert(isFerrousToday(d20) === true, '20 Sep should be due');
        console.assert(isFerrousToday(d21) === false, '21 Sep should NOT be due');
        logOK('Ferrous every-2-days checks passed');

        // Next due tests
        console.assert(nextFerrousDue(d18).toDateString() === d18.toDateString(), 'Next due on 18th should be 18th');
        console.assert(nextFerrousDue(d19).toDateString() === d20.toDateString(), 'Next due on 19th should be 20th');
        console.assert(nextFerrousDue(d20).toDateString() === d20.toDateString(), 'Next due on 20th should be 20th');
        console.assert(nextFerrousDue(d21).toDateString() === new Date(2025,8,22).toDateString(), 'Next due on 21st should be 22nd');
        logOK('Next-due date checks passed');

        // Multiple-detection tests (dosage-sensitive)
        const t500 = multiMap.map.get(multiMap.norm('Levetiracetam (500 mg)')) || [];
        const t1000 = multiMap.map.get(multiMap.norm('Levetiracetam (1000 mg)')) || [];
        console.assert(t500.length === 1 && t500[0] === 'Lunch', '500 mg should appear only at Lunch');
        console.assert(t1000.length === 2 && t1000.includes('Morning') && t1000.includes('Night'), '1000 mg should appear Morning & Night');
        logOK('Multiple/duplicate highlighting checks passed');

        // Azithromycin weekday schedule tests (Mon/Wed/Fri)
        const mon = new Date(2025,8,15); // Mon
        const tue = new Date(2025,8,16); // Tue
        const wed = new Date(2025,8,17); // Wed
        const thu = new Date(2025,8,18); // Thu
        const fri = new Date(2025,8,19); // Fri
        console.assert(isAzithroToday(mon) === true, 'Mon should be due for Azithromycin');
        console.assert(isAzithroToday(tue) === false, 'Tue should NOT be due for Azithromycin');
        console.assert(isAzithroToday(wed) === true, 'Wed should be due for Azithromycin');
        console.assert(isAzithroToday(thu) === false, 'Thu should NOT be due for Azithromycin');
        console.assert(isAzithroToday(fri) === true, 'Fri should be due for Azithromycin');
        const nextFromTue = nextAzithroDue(tue);
        console.assert(nextFromTue.toDateString() === wed.toDateString(), 'Next Azithro due from Tue should be Wed');
        logOK('Azithromycin M/W/F checks passed');
      } catch (e) {
        logErr('Self-tests encountered an error: ' + (e && e.message ? e.message : e));
      }
    })();
  </script>
</body>
</html>
